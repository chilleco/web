# Local development overrides

services:
  mq:
    ports:
      - 6379:6379

  db:
    image: mongo:7.0
    restart: unless-stopped
    env_file: ../../.env
    environment:
      MONGO_INITDB_DATABASE: admin
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS}
    volumes:
      - ${DATA_PATH}/db:/data/db
      - ${DATA_PATH}/logs/mongodb.log:/data/logs/mongodb.log
      - ../mongo/mongod.conf:/etc/mongod.conf
    ports:
      - 27017:27017
    command: --config /etc/mongod.conf

  api:
    depends_on:
      - db
    volumes:
      # For hot reload
      - ../../api/app:/app
    command: bash -c "cd /app && uv run uvicorn main:app --host 0.0.0.0 --port 5000 --proxy-headers --reload"
    # healthcheck:
    #   test: "curl --fail http://0.0.0.0:5000/"
    #   interval: 1s
    #   timeout: 1s
    #   start_period: 180s
    #   retries: 180

  # jobs:
  #   image: ${PROJECT_NAME}/jobs
  #   build: ./api
  #   restart: unless-stopped
  #   environment:
  #     API: http://localhost/api/
  #     WEB: http://localhost/
  #   volumes:
  #     - ${DATA_PATH}/load:/data/load
  #     - ${DATA_PATH}/backup:/backup
  #     - ./scripts:/app/scripts
  #     # For hot reload
  #     - ./api:/app
  #     # For logs
  #     - ${DATA_PATH}/logs/jobs.err:/app/app.err
  #     - ${DATA_PATH}/logs/jobs.log:/app/app.log
  #     # For sitemap
  #     - ${DATA_PATH}/sitemaps:/data/sitemaps
  #     - ${DATA_PATH}/sitemap.xml:/data/sitemap.xml
  #     - ${DATA_PATH}/robots.txt:/data/robots.txt
  #   command: bash -c "cd /app && dramatiq --verbose tasks"

  # cron:
  #   image: ${PROJECT_NAME}/cron
  #   build: ./api
  #   restart: unless-stopped
  #   depends_on:
  #     - jobs
  #   env_file: .env
  #   command: bash -c "cd /app && python cron.py"

  web:
    build:
      context: ../../web
      target: development
    volumes:
      # For hot reload in development
      - ../../web:/app
      # Exclude to avoid conflicts and cache issues
      - /app/node_modules
      - /app/.next
      - /app/.swc
    command: npm run dev

  server:
    image: nginx:1.29
    restart: unless-stopped
    env_file: ../../.env
    volumes:
      - ../nginx/local.conf:/etc/nginx/nginx.conf
      - ${DATA_PATH}/load:/load
      - ${DATA_PATH}/logs:/data/logs
      # For sitemap
      - ${DATA_PATH}/sitemaps:/data/sitemaps
      - ${DATA_PATH}/sitemap.xml:/data/sitemap.xml
      - ${DATA_PATH}/robots.txt:/data/robots.txt
    depends_on:
      - api
      # - jobs
      - web
    ports:
      - ${EXTERNAL_PORT}:80
